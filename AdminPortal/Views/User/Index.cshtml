@using AdminPortal.Models
@model Tuple<List<UserModel>, List<Pagination>>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <a href="/User/CreateUser" class="btn bg-gradient-dark ml-auto">
                <i class="fa fa-plus"></i>
                Add User
            </a>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="form1" method="post" action="/User/Index/@ViewBag.pageNumber">
                        <div class="row">
                            <div class="col-md-3">
                                @Html.LabelFor(model => model.Item1[0].username)
                                <input type="text" name="username" class="form-control" placeholder="username" value="@ViewBag.username" />
                            </div>
                            <div class="col-md-3">
                                @Html.LabelFor(model => model.Item1[0].email)
                                <input type="email" name="email" class="form-control" placeholder="Email" value="@ViewBag.email" />
                            </div>
                            <div class="col-md-3">
                                @Html.LabelFor(model => model.Item1[0].user_mobile)
                                <input type="text" name="user_mobile" class="form-control" placeholder="Mobile Number" value="@ViewBag.user_mobile" />
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn bg-gradient-dark sender-button mt-4" id="fetch">Search</button>
                            </div>
                        </div>
                    </form>

                    <hr />

                    <!-- Modal -->
                    @{
                        Html.RenderAction("_updateUser", "User");
                    }
                    <!-- Modal -->
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th hidden>Id</th>
                                    <th>FullName</th>
                                    <th>User Name</th>
                                    <th>Email</th>
                                    <th hidden>GroupId</th>
                                    <th>User Group</th>
                                    <th>Mobile Number</th>
                                    <th>User Expiry</th>
                                    <th hidden>status</th>
                                    <th hidden>otp_access</th>
                                    <th style="width: 10%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Item1.Count > 0)
                                {
                                    foreach (var userItems in Model.Item1)
                                    {
                                        <tr>
                                            <td hidden>@userItems.Id</td>
                                            <td>@userItems.fullname</td>
                                            <td>@userItems.username</td>
                                            <td>@userItems.email</td>
                                            <td hidden>@userItems.GroupId</td>
                                            <td>@userItems.GroupName</td>
                                            <td>@userItems.user_mobile</td>
                                            <td>@userItems.user_expiry.ToString("yyyy-MM-dd")</td>
                                            <td hidden>@userItems.status</td>
                                            <td hidden>@userItems.otp_access</td>
                                            <td><button class="btn bg-gradient-dark edit" data-toggle="modal" data-target="#addRowModal">Edit</button><button class="btn bg-gradient-danger delete">Delete</button></td>
                                        </tr>

                                    }
                                }
                                else
                                {
                                    <tr><td>No records found</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @foreach (var paginationItems in Model.Item2)
                    {
                        var previous = paginationItems.currentPage - 1;
                        var next = paginationItems.currentPage + 1;
                        var isActive = "";
                        var start = paginationItems.currentPage - 2;
                        var end = paginationItems.currentPage + 1;

                        if (start < 1)
                        {
                            start = 1;
                        }

                        if (end >= paginationItems.totalPages)
                        {
                            end = paginationItems.totalPages;
                        }
                        else
                        {
                            end += 1;
                        }

                        <nav aria-label="Page navigation example align-middle">
                            <ul class="pagination">
                                @if (paginationItems.currentPage > 1)
                                {
                                    <!--Previous page-->
                                    <li class="page-item text-white">
                                        <a class="page-link bg-gradient-dark text-white" href="?page=@previous&search=@ViewBag.search" aria-label="Previous">
                                            <i class="fa fa-angle-left"></i>
                                            <span class="sr-only">Previous</span>
                                        </a>
                                    </li>
                                }
                                @if (start > 1)
                                {
                                    <!--first page-->
                                    isActive = (paginationItems.currentPage == 1) ? "active" : "";
                                    <li class="page-item text-white @isActive"><a class="page-link bg-gradient-dark text-white" href="?page=1&search=@ViewBag.search">1</a></li>

                                    if (start >= 3)
                                    {
                                        <li class="page-item text-white"><a class="page-link bg-gradient-dark text-white" href="#">...</a></li>
                                    }
                                }

                                <!--links-->
                                @for (var i = start; i <= end; i++)
                                {
                                    isActive = (paginationItems.currentPage == @i) ? "active" : "";
                                    <li class="page-item text-white @isActive"><a class="page-link bg-gradient-dark text-white" href="?page=@i&search=@ViewBag.search">@i</a></li>
                                }

                                <!--last page-->
                                @if (end < paginationItems.totalPages)
                                {
                                    if ((paginationItems.currentPage + 3) != paginationItems.totalPages)
                                    {
                                        <li class="page-item text-white"><a class="page-link bg-gradient-dark text-white" href="#">...</a></li>
                                    }
                                    <li class="page-item text-white"><a class="page-link bg-gradient-dark text-white" href="?page=@paginationItems.totalPages&search=@ViewBag.search">@paginationItems.totalPages</a></li>
                                }

                                @if (paginationItems.currentPage < paginationItems.totalPages)
                                {
                                    <!--Next Page-->
                                    <li class="page-item text-white">
                                        <a class="page-link bg-gradient-dark text-white" href="?page=@next&search=@ViewBag.search" aria-label="Next">
                                            <i class="fa fa-angle-right"></i>
                                            <span class="sr-only">Next</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }

                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/Scripts/ProjectScript/CommonMethods.js"></script>
<script src="~/Scripts/ProjectScript/CrudScript.js"></script>
<script>
    var form = $("#form");
    
    $(document).on("focusout", "#username", function () {
        var username = $(this).val();
        if (username != null && username != '') {

            CrudScript.makeAjaxRequest('Post', '/User/CheckUsername', { username: username }).then(function (data) {
                if (data == false) {
                    $('#msg').css('display', 'block');
                    $('#username').attr('readonly', false);

                }
                else {
                    $('#username').attr('readonly', true);
                    $('#msg').css('display', 'none');
                }
            })
        }

    });

    $(document).on("focusout", "#email", function () {
        var re = /\S+@@\S+\.\S+/;
        if (re.test($(this).val())) {
            var username = $(this).val().substr(0, $(this).val().indexOf('@@'));
            $('#username').val(username);
            $("#username").trigger("focusout");

        }
    });

    $(document).on('click', '.delete', async function () {
        debugger
        var Id = $(this).closest('tr').find("td:eq(0)").text();
        var url = '/User/DeleteUser';

        await DeleteConfirm(url,Id);
    });
    $(document).on('click', '.edit', function () {
        var currentRow = $(this).closest('tr');
        $('#addRowModal').modal("show");
        $('.fw-mediumbold').text('Update');
        $('#btnUpdate').css('display', 'block');
        $('#btnSubmit').css('display', 'none');
        $('#Id').val(currentRow.find("td:eq(0)").text());
        $('#fullname').val(currentRow.find("td:eq(1)").text());
        $('#email').val(currentRow.find("td:eq(3)").text());
        $('#user_mobile').val(currentRow.find("td:eq(6)").text());
        $('#user_expiry').val(currentRow.find("td:eq(7)").text());
        debugger
        CrudScript.makeAjaxRequest('Post', '/User/SelectedMaskings/' + currentRow.find("td:eq(0)").text()).then(function (data) {
            if (data.maskings != null) {
                for (var i in data.maskings) {
                    $("#masking").find("option[value=" + data.maskings[i].id + "]").prop("selected", "");
                }
            }
            if (data.selectedMaskings != "") {
                var selectedOptions = data.selectedMaskings.split(",");
                for (var i in selectedOptions) {
                    var optionVal = selectedOptions[i];
                    $("#masking").find("option[value=" + optionVal + "]").prop("selected", "selected");
                }
            }
            $('#masking').selectpicker({
                showSubtext: true,
                liveSearch: true,
            });
            $("#masking").selectpicker('refresh');
        })

        $('#GroupId').val(currentRow.find("td:eq(4)").text()).prop("selected", "selected");
        $('#status').attr('checked', currentRow.find("td:eq(8)").text());
        $('#otp_access').attr('checked', currentRow.find("td:eq(9)").text());
    });

    $('#btnUpdate').click(function () {
        $("#otp_access").val(false);
        $("#status").val(false);
        if ($("#status").prop('checked')) {
            $("#status").val(true);
        }

        if ($("#otp_access").prop('checked')) {
            $("#otp_access").val(true);
        }

        if (form.valid()) {
            CrudScript.makeAjaxRequest('Post', '/User/UpdateUser', form.serialize()).then(function (data) {
                $('#addRowModal').modal("hide");
                if (data.status == true) {
                    ShowDivSuccess(data.message);
                    window.location.reload();
                }
                else {
                    ShowDivError(data.message);
                }
            })
        }
        else {
            ShowDivError("Input Data is not valid");
        }

    });

    function ClearFields() {
        $('#Id').val();
        $('#msg').css('display', 'none');
        $('#fullname').val("");
        $('#username').val('');
        $('#email').val('');
        $('#password').val('');
    }

    function DateFormatString(expireDate) {
        var str = (expireDate).substring(6, 19);
        var date = new Date(parseInt(str));
        var localdate = String(date.getFullYear()).padStart(4, '0') + '-' + String((date.getMonth() + 1)).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
        return localdate;
    }
</script>